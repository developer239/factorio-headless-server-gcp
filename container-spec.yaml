spec:
  # PERMISSION FIX: Use initContainer to set proper ownership
  initContainers:
    - name: fix-permissions
      image: alpine:latest
      command: ['sh', '-c']
      args:
        - |
          echo "Fixing permissions for factorio data directory..."
          chown -R 845:845 /data/factorio
          chmod -R 755 /data/factorio
          echo "Permissions fixed successfully"
      volumeMounts:
        - name: factorio-data
          mountPath: /data/factorio
      securityContext:
        runAsUser: 0  # Run as root to fix permissions
  containers:
    - name: factorio
      image: jarnotmichal/factorio-with-http-controls:2.0.55-6
      imagePullPolicy: Always
      ports:
        - containerPort: 34197
          protocol: UDP
        - containerPort: 27015
          protocol: TCP
        - containerPort: 8080
          protocol: TCP
      env:
        - name: FACTORIO_SERVER_NAME
          value: "${server_name}"
        - name: FACTORIO_SERVER_DESCRIPTION
          value: "${server_description}"
        - name: FACTORIO_MAX_PLAYERS
          value: "${max_players}"
        - name: FACTORIO_ADMIN_USERS
          value: '${admin_users}'
        - name: FACTORIO_SAVE_NAME
          value: "default"
        - name: FACTORIO_AUTOSAVE_INTERVAL
          value: "${autosave_interval}"
        - name: FACTORIO_AUTOSAVE_SLOTS
          value: "${autosave_slots}"
        - name: PORT
          value: "8080"
      volumeMounts:
        - name: factorio-data
          mountPath: /data/factorio
      restartPolicy: Always
      securityContext:
        runAsUser: 845
        runAsGroup: 845
        fsGroup: 845
        # Additional security context to ensure proper permissions
        fsGroupChangePolicy: "Always"
  volumes:
    - name: factorio-data
      hostPath:
        path: /mnt/stateful_partition/factorio
        type: DirectoryOrCreate
